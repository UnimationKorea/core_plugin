<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üìö Î†àÏä® ÎπåÎçî</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1e1e2e;
            color: #cdd6f4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #313244;
            padding: 1rem 2rem;
            border-bottom: 1px solid #45475a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #cba6f7;
            font-size: 1.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        .sidebar {
            width: 320px;
            background: #313244;
            border-right: 1px solid #45475a;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background: #45475a;
            padding: 1rem 2rem;
            border-bottom: 1px solid #6c7086;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .workspace {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .card {
            background: #45475a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #6c7086;
        }
        
        .card-title {
            color: #fab387;
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            color: #a6adc8;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            background: #313244;
            border: 1px solid #6c7086;
            border-radius: 6px;
            padding: 0.75rem;
            color: #cdd6f4;
            font-size: 0.95rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #89b4fa;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            width: 100%;
            background: #313244;
            border: 1px solid #6c7086;
            border-radius: 6px;
            padding: 0.75rem;
            color: #cdd6f4;
            cursor: pointer;
        }
        
        .btn {
            background: #89b4fa;
            color: #1e1e2e;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background: #74c7ec;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #6c7086;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #a6e3a1;
        }
        
        .btn-success:hover {
            background: #94e2d5;
        }
        
        .btn-danger {
            background: #f38ba8;
        }
        
        .btn-danger:hover {
            background: #eba0ac;
        }
        
        .btn-secondary {
            background: #6c7086;
        }
        
        .btn-secondary:hover {
            background: #585b70;
        }
        
        .activity-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .activity-item {
            background: #585b70;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .activity-item:hover {
            background: #6c7086;
        }
        
        .activity-item.selected {
            border-color: #89b4fa;
            background: rgba(137, 180, 250, 0.1);
        }
        
        .activity-type {
            color: #fab387;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .activity-title {
            font-weight: 600;
            margin: 0.5rem 0;
        }
        
        .activity-description {
            color: #a6adc8;
            font-size: 0.9rem;
        }
        
        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .template-card {
            background: #313244;
            border: 2px solid #6c7086;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-card:hover {
            border-color: #89b4fa;
            background: #45475a;
        }
        
        .template-card.selected {
            border-color: #a6e3a1;
            background: rgba(166, 227, 161, 0.1);
        }
        
        .template-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .template-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .template-desc {
            color: #a6adc8;
            font-size: 0.8rem;
        }
        
        .choice-builder {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .choice-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .choice-input {
            flex: 1;
        }
        
        .choice-correct {
            width: 20px;
            height: 20px;
        }
        
        .json-preview {
            background: #1e1e2e;
            border: 1px solid #45475a;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #cdd6f4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #89b4fa;
            color: #1e1e2e;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #a6e3a1;
        }
        
        .notification.error {
            background: #f38ba8;
        }
        
        .notification.warning {
            background: #fab387;
        }
        
        .tabs {
            display: flex;
            background: #313244;
            border-bottom: 1px solid #45475a;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: #45475a;
        }
        
        .tab.active {
            border-bottom-color: #89b4fa;
            color: #89b4fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c7086;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* Ïà®ÍπÄ ÏöîÏÜå */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Î†àÏä® ÎπåÎçî</h1>
        <div class="header-actions">
            <button class="btn btn-success" id="save-lesson-btn" disabled>üíæ Î†àÏä® Ï†ÄÏû•</button>
            <button class="btn" id="preview-lesson-btn" disabled>üëÅÔ∏è ÎØ∏Î¶¨Î≥¥Í∏∞</button>
            <button class="btn btn-secondary" id="export-json-btn" disabled>üì§ JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <!-- Î†àÏä® Ï†ïÎ≥¥ -->
            <div class="card" style="margin-bottom: 0;">
                <div class="card-title">Î†àÏä® Ï†ïÎ≥¥</div>
                
                <div class="form-group">
                    <label class="form-label">Î†àÏä® Ï†úÎ™©</label>
                    <input type="text" class="form-input" id="lesson-title" placeholder="Î†àÏä® Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÏÑ§Î™Ö</label>
                    <textarea class="form-input form-textarea" id="lesson-description" placeholder="Î†àÏä®Ïóê ÎåÄÌïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÎÇúÏù¥ÎèÑ</label>
                    <select class="form-select" id="lesson-difficulty">
                        <option value="beginner">Ï¥àÍ∏â</option>
                        <option value="intermediate">Ï§ëÍ∏â</option>
                        <option value="advanced">Í≥†Í∏â</option>
                        <option value="mixed">ÌòºÌï©</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÏòàÏÉÅ ÏãúÍ∞Ñ (Î∂Ñ)</label>
                    <input type="number" class="form-input" id="lesson-time" placeholder="15" min="1" max="120">
                </div>
            </div>
            
            <!-- ÌôúÎèô Î™©Î°ù -->
            <div style="border-top: 1px solid #45475a; padding-top: 1rem;">
                <div style="padding: 0 1.5rem; margin-bottom: 1rem; display: flex; justify-content: between; align-items: center;">
                    <div class="card-title" style="margin: 0;">ÌôúÎèô Î™©Î°ù</div>
                    <button class="btn" id="add-activity-btn">‚ûï ÌôúÎèô Ï∂îÍ∞Ä</button>
                </div>
                
                <div class="activity-list" id="activity-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>ÌôúÎèôÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="toolbar">
                <select class="form-select" id="template-select" style="width: 250px;">
                    <option value="">ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    <optgroup label="ÎÇ¥Ïû• ÌÖúÌîåÎ¶ø">
                        <option value="multiple-choice">üîò 4ÏßÄ ÏÑ†Îã§Ìòï</option>
                        <option value="word-guess">üî§ Îã®Ïñ¥ ÎßûÏ∂îÍ∏∞</option>
                        <option value="memory-game">üß† Î©îÎ™®Î¶¨ Í≤åÏûÑ</option>
                        <option value="video">üé• ÎπÑÎîîÏò§</option>
                        <option value="quiz">‚ùì ÌÄ¥Ï¶à</option>
                        <option value="survey">üìã ÏÑ§Î¨∏Ï°∞ÏÇ¨</option>
                    </optgroup>
                    <optgroup label="Ïô∏Î∂Ä ÌîåÎü¨Í∑∏Ïù∏">
                        <option value="fill-in-blanks">‚úèÔ∏è ÎπàÏπ∏ Ï±ÑÏö∞Í∏∞</option>
                        <option value="chinese-pinyin-match">üÄÑ Ï§ëÍµ≠Ïñ¥ Î≥ëÏùå Îß§Ïπ≠</option>
                    </optgroup>
                </select>
                
                <button class="btn" id="create-activity-btn" disabled>ÌôúÎèô ÏÉùÏÑ±</button>
                
                <div style="flex: 1;"></div>
                
                <button class="btn btn-secondary" id="delete-activity-btn" disabled>üóëÔ∏è ÏÇ≠Ï†ú</button>
            </div>
            
            <div class="workspace" id="workspace">
                <!-- Í∏∞Î≥∏ ÏÉÅÌÉú -->
                <div id="welcome-state">
                    <div class="empty-state">
                        <div class="empty-state-icon">üöÄ</div>
                        <h2>Î†àÏä® ÎπåÎçîÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!</h2>
                        <p>Ï¢åÏ∏°ÏóêÏÑú Î†àÏä® Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÍ≥† ÌôúÎèôÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî.</p>
                    </div>
                </div>
                
                <!-- ÌôúÎèô Ìé∏ÏßëÍ∏∞ -->
                <div id="activity-editor" class="hidden">
                    <div class="tabs">
                        <div class="tab active" data-tab="edit">‚úèÔ∏è Ìé∏Ïßë</div>
                        <div class="tab" data-tab="preview">üëÅÔ∏è ÎØ∏Î¶¨Î≥¥Í∏∞</div>
                        <div class="tab" data-tab="json">üîß JSON</div>
                    </div>
                    
                    <div class="tab-content active" id="edit-tab">
                        <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê† Ìé∏Ïßë Ìèº -->
                    </div>
                    
                    <div class="tab-content" id="preview-tab">
                        <!-- ÌôúÎèô ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                    </div>
                    
                    <div class="tab-content" id="json-tab">
                        <div class="card">
                            <div class="card-title">JSON ÎØ∏Î¶¨Î≥¥Í∏∞</div>
                            <div class="json-preview" id="json-preview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Ï†ÑÏó≠ ÏÉÅÌÉú
        let currentLesson = {
            lessonId: '',
            title: '',
            description: '',
            locale: 'ko',
            version: '1.0.0',
            flow: [],
            grading: {
                mode: 'weighted-sum',
                passLine: 0.7,
                showScores: true,
                showProgress: true
            },
            metadata: {
                author: 'Lesson Builder',
                createdAt: new Date().toISOString(),
                tags: [],
                difficulty: 'intermediate',
                estimatedTime: 15
            }
        };
        
        let selectedActivityIndex = -1;
        let activities = [];
        
        // DOM ÏöîÏÜåÎì§
        const lessonTitle = document.getElementById('lesson-title');
        const lessonDescription = document.getElementById('lesson-description');
        const lessonDifficulty = document.getElementById('lesson-difficulty');
        const lessonTime = document.getElementById('lesson-time');
        const activityList = document.getElementById('activity-list');
        const addActivityBtn = document.getElementById('add-activity-btn');
        const templateSelect = document.getElementById('template-select');
        const createActivityBtn = document.getElementById('create-activity-btn');
        const deleteActivityBtn = document.getElementById('delete-activity-btn');
        const saveLessonBtn = document.getElementById('save-lesson-btn');
        const previewLessonBtn = document.getElementById('preview-lesson-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const workspace = document.getElementById('workspace');
        const welcomeState = document.getElementById('welcome-state');
        const activityEditor = document.getElementById('activity-editor');
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        lessonTitle.addEventListener('input', updateLessonInfo);
        lessonDescription.addEventListener('input', updateLessonInfo);
        lessonDifficulty.addEventListener('change', updateLessonInfo);
        lessonTime.addEventListener('input', updateLessonInfo);
        
        addActivityBtn.addEventListener('click', showTemplateSelector);
        templateSelect.addEventListener('change', function() {
            createActivityBtn.disabled = !templateSelect.value;
        });
        createActivityBtn.addEventListener('click', createNewActivity);
        deleteActivityBtn.addEventListener('click', deleteActivity);
        
        saveLessonBtn.addEventListener('click', saveLesson);
        previewLessonBtn.addEventListener('click', previewLesson);
        exportJsonBtn.addEventListener('click', exportJson);
        
        // ÌÉ≠ Ï†ÑÌôò
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab')) {
                switchTab(e.target.dataset.tab);
            }
        });
        
        // Î†àÏä® Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateLessonInfo() {
            currentLesson.title = lessonTitle.value;
            currentLesson.description = lessonDescription.value;
            currentLesson.metadata.difficulty = lessonDifficulty.value;
            currentLesson.metadata.estimatedTime = parseInt(lessonTime.value) || 15;
            currentLesson.lessonId = generateLessonId(lessonTitle.value);
            
            updateButtonStates();
        }
        
        // Î†àÏä® ID ÏÉùÏÑ±
        function generateLessonId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9Í∞Ä-Ìû£\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50) + '-' + Date.now().toString(36);
        }
        
        // ÌÖúÌîåÎ¶ø ÏÑ†ÌÉùÍ∏∞ ÌëúÏãú
        function showTemplateSelector() {
            // ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù Î™®Îã¨Ïù¥ÎÇò ÏÇ¨Ïù¥ÎìúÎ∞î ÌëúÏãú
            templateSelect.focus();
            showNotification('ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÍ≥† "ÌôúÎèô ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî', 'info');
        }
        
        // ÏÉà ÌôúÎèô ÏÉùÏÑ±
        function createNewActivity() {
            const templateType = templateSelect.value;
            if (!templateType) return;
            
            const newActivity = createActivityTemplate(templateType);
            activities.push(newActivity);
            currentLesson.flow.push(newActivity);
            
            renderActivityList();
            selectActivity(activities.length - 1);
            
            templateSelect.value = '';
            createActivityBtn.disabled = true;
            
            showNotification('ÏÉà ÌôúÎèôÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        // ÌôúÎèô ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
        function createActivityTemplate(type) {
            const activityId = `activity-${Date.now()}`;
            
            const baseActivity = {
                activityId: activityId,
                template: `${type}@1.0.0`,
                rules: {
                    scoreWeight: 1,
                    required: true
                }
            };
            
            switch (type) {
                case 'multiple-choice':
                    return {
                        ...baseActivity,
                        params: {
                            question: 'ÏÉàÎ°úÏö¥ ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                            choices: [
                                { id: 'choice-a', text: 'ÏÑ†ÌÉùÏßÄ 1' },
                                { id: 'choice-b', text: 'ÏÑ†ÌÉùÏßÄ 2' },
                                { id: 'choice-c', text: 'ÏÑ†ÌÉùÏßÄ 3' },
                                { id: 'choice-d', text: 'ÏÑ†ÌÉùÏßÄ 4' }
                            ],
                            correctAnswer: 'choice-a',
                            allowMultiple: false,
                            shuffle: true,
                            timeLimit: 30,
                            explanation: 'Ï†ïÎãµÏóê ÎåÄÌïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                            showFeedback: true,
                            hints: []
                        }
                    };
                    
                case 'word-guess':
                    return {
                        ...baseActivity,
                        params: {
                            word: 'Îã®Ïñ¥',
                            hint: 'ÌûåÌä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                            category: 'Ïπ¥ÌÖåÍ≥†Î¶¨',
                            maxAttempts: 6,
                            showHintAfter: 3,
                            timeLimit: 120,
                            difficulty: 'Î≥¥ÌÜµ'
                        }
                    };
                    
                case 'memory-game':
                    return {
                        ...baseActivity,
                        params: {
                            title: 'Î©îÎ™®Î¶¨ Í≤åÏûÑ',
                            cards: [
                                { id: 'card-1', content: 'Ïπ¥Îìú 1', type: 'text', matchId: 'pair1' },
                                { id: 'card-2', content: 'Ïπ¥Îìú 1 Îß§Ïπò', type: 'text', matchId: 'pair1' },
                                { id: 'card-3', content: 'Ïπ¥Îìú 2', type: 'text', matchId: 'pair2' },
                                { id: 'card-4', content: 'Ïπ¥Îìú 2 Îß§Ïπò', type: 'text', matchId: 'pair2' }
                            ],
                            gridSize: '2x2',
                            timeLimit: 120,
                            allowRetries: true,
                            maxAttempts: 5,
                            showTimer: true,
                            successMessage: 'Ï∂ïÌïòÌï©ÎãàÎã§!',
                            failureMessage: 'Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî',
                            hints: [],
                            shuffle: true
                        }
                    };
                    
                case 'video':
                    return {
                        ...baseActivity,
                        params: {
                            title: 'ÎπÑÎîîÏò§ ÌôúÎèô',
                            src: '',
                            description: 'ÎπÑÎîîÏò§ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                            autoplay: false,
                            controls: true
                        }
                    };
                    
                case 'quiz':
                    return {
                        ...baseActivity,
                        params: {
                            question: 'ÌÄ¥Ï¶à ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                            choices: ['ÏÑ†ÌÉùÏßÄ 1', 'ÏÑ†ÌÉùÏßÄ 2', 'ÏÑ†ÌÉùÏßÄ 3', 'ÏÑ†ÌÉùÏßÄ 4'],
                            correct: 'ÏÑ†ÌÉùÏßÄ 1'
                        }
                    };
                    
                case 'fill-in-blanks':
                    return {
                        ...baseActivity,
                        template: 'fill-in-blanks@1.0.0',
                        params: {
                            title: 'ÎπàÏπ∏ Ï±ÑÏö∞Í∏∞',
                            sentence: 'Í≥†ÏñëÏù¥Í∞Ä {blank}Î•º Ï´ìÏïÑÍ∞ÑÎã§.',
                            blanks: [
                                { id: 'blank-1', position: '{blank}', answer: 'Ï•ê', alternatives: ['Ï•ê', 'ÏÉùÏ•ê'] }
                            ],
                            caseSensitive: false,
                            showHints: true,
                            hints: ['ÏûëÏùÄ ÎèôÎ¨º', 'ÏπòÏ¶àÎ•º Ï¢ãÏïÑÌï®'],
                            timeLimit: 0,
                            feedback: {
                                correct: 'Ï†ïÎãµÏûÖÎãàÎã§! üéâ',
                                incorrect: 'Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî. üí≠',
                                timeout: 'ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§! ‚è∞',
                                complete: 'Î™®Îì† ÎπàÏπ∏ÏùÑ ÏôÑÏÑ±ÌñàÏäµÎãàÎã§! üåü'
                            },
                            allowMultipleAttempts: true,
                            showProgressBar: true,
                            autoCheckOnComplete: false
                        }
                    };
                    
                case 'chinese-pinyin-match':
                    return {
                        ...baseActivity,
                        template: 'chinese-pinyin-match@1.0.0',
                        params: {
                            words: [
                                { hanzi: '‰Ω†Â•Ω', pinyin: 'n«êh«éo', meaning: 'ÏïàÎÖïÌïòÏÑ∏Ïöî' },
                                { hanzi: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', meaning: 'Í∞êÏÇ¨Ìï©ÎãàÎã§' },
                                { hanzi: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', meaning: 'ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî' },
                                { hanzi: 'Êó©‰∏äÂ•Ω', pinyin: 'z«éoshang h«éo', meaning: 'Ï¢ãÏùÄ ÏïÑÏπ®ÏûÖÎãàÎã§' },
                                { hanzi: 'ÊôöÂÆâ', pinyin: 'w«én\'ƒÅn', meaning: 'ÏïàÎÖïÌûà Ï£ºÎ¨¥ÏÑ∏Ïöî' },
                                { hanzi: 'ÂØπ‰∏çËµ∑', pinyin: 'du√¨b√πq«ê', meaning: 'Ï£ÑÏÜ°Ìï©ÎãàÎã§' }
                            ],
                            showHint: true,
                            autoShuffle: true,
                            successMessage: 'Ï∂ïÌïòÌï©ÎãàÎã§! Î™®Îì† Îß§Ïπ≠ÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§! üéâ',
                            failMessage: 'ÏïÑÏßÅ Îß§Ïπ≠ÎêòÏßÄ ÏïäÏùÄ Ìï≠Î™©Ïù¥ ÏûàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî!'
                        }
                    };
                    
                case 'survey':
                    return {
                        ...baseActivity,
                        params: {
                            questions: [
                                {
                                    type: 'multiple-choice',
                                    question: 'ÏÉòÌîå Í∞ùÍ¥ÄÏãù ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                                    options: ['ÏòµÏÖò 1', 'ÏòµÏÖò 2', 'ÏòµÏÖò 3'],
                                    required: true
                                },
                                {
                                    type: 'rating',
                                    question: 'ÌèâÏ†êÏùÑ Îß§Í≤®Ï£ºÏÑ∏Ïöî',
                                    scale: 5,
                                    scaleLabels: ['Îß§Ïö∞ ÎÇòÏÅ®', 'Îß§Ïö∞ Ï¢ãÏùå'],
                                    required: true
                                },
                                {
                                    type: 'text',
                                    question: 'ÏûêÏú†Î°≠Í≤å ÏùòÍ≤¨ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî',
                                    required: false
                                }
                            ]
                        }
                    };
                    
                default:
                    return baseActivity;
            }
        }
        
        // ÌôúÎèô Î™©Î°ù Î†åÎçîÎßÅ
        function renderActivityList() {
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>ÌôúÎèôÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</p>
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = activities.map((activity, index) => {
                const templateType = activity.template.split('@')[0];
                const typeLabels = {
                    'multiple-choice': '4ÏßÄ ÏÑ†Îã§Ìòï',
                    'word-guess': 'Îã®Ïñ¥ ÎßûÏ∂îÍ∏∞',
                    'memory-game': 'Î©îÎ™®Î¶¨ Í≤åÏûÑ',
                    'video': 'ÎπÑÎîîÏò§',
                    'quiz': 'ÌÄ¥Ï¶à',
                    'survey': 'ÏÑ§Î¨∏Ï°∞ÏÇ¨'
                };
                
                return `
                    <div class="activity-item ${index === selectedActivityIndex ? 'selected' : ''}" 
                         onclick="selectActivity(${index})">
                        <div class="activity-type">${typeLabels[templateType] || templateType}</div>
                        <div class="activity-title">${activity.params.question || activity.params.title || activity.activityId}</div>
                        <div class="activity-description">ÌôúÎèô ${index + 1}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ÌôúÎèô ÏÑ†ÌÉù
        function selectActivity(index) {
            selectedActivityIndex = index;
            renderActivityList();
            
            if (index >= 0 && index < activities.length) {
                showActivityEditor(activities[index]);
                deleteActivityBtn.disabled = false;
            } else {
                hideActivityEditor();
                deleteActivityBtn.disabled = true;
            }
        }
        
        // ÌôúÎèô Ìé∏ÏßëÍ∏∞ ÌëúÏãú
        function showActivityEditor(activity) {
            welcomeState.classList.add('hidden');
            activityEditor.classList.remove('hidden');
            
            renderActivityEditor(activity);
        }
        
        // ÌôúÎèô Ìé∏ÏßëÍ∏∞ Ïà®ÍπÄ
        function hideActivityEditor() {
            welcomeState.classList.remove('hidden');
            activityEditor.classList.add('hidden');
        }
        
        // ÌôúÎèô Ìé∏ÏßëÍ∏∞ Î†åÎçîÎßÅ
        function renderActivityEditor(activity) {
            const editTab = document.getElementById('edit-tab');
            const templateType = activity.template.split('@')[0];
            
            let editorHtml = '';
            
            switch (templateType) {
                case 'multiple-choice':
                    editorHtml = renderMultipleChoiceEditor(activity);
                    break;
                case 'word-guess':
                    editorHtml = renderWordGuessEditor(activity);
                    break;
                case 'memory-game':
                    editorHtml = renderMemoryGameEditor(activity);
                    break;
                case 'video':
                    editorHtml = renderVideoEditor(activity);
                    break;
                case 'quiz':
                    editorHtml = renderQuizEditor(activity);
                    break;
                case 'survey':
                    editorHtml = renderSurveyEditor(activity);
                    break;
                case 'fill-in-blanks':
                    editorHtml = renderExternalPluginEditor(activity, '‚úèÔ∏è ÎπàÏπ∏ Ï±ÑÏö∞Í∏∞ ÌîåÎü¨Í∑∏Ïù∏');
                    break;
                case 'chinese-pinyin-match':
                    editorHtml = renderExternalPluginEditor(activity, 'üÄÑ Ï§ëÍµ≠Ïñ¥ Î≥ëÏùå Îß§Ïπ≠ ÌîåÎü¨Í∑∏Ïù∏');
                    break;
                default:
                    editorHtml = '<div class="card"><div class="card-title">ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌÖúÌîåÎ¶ø</div></div>';
            }
            
            editTab.innerHTML = editorHtml;
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ïó∞Í≤∞
            attachEditorEvents();
            updateJsonPreview();
        }
        
        // 4ÏßÄ ÏÑ†Îã§Ìòï Ìé∏ÏßëÍ∏∞
        function renderMultipleChoiceEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">üîò 4ÏßÄ ÏÑ†Îã§Ìòï Î¨∏Ï†ú Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏßàÎ¨∏</label>
                        <textarea class="form-input form-textarea" id="question" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${params.question}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ†ÌÉùÏßÄ</label>
                        <div class="choice-builder" id="choice-builder">
                            ${params.choices.map((choice, index) => `
                                <div class="choice-item">
                                    <input type="text" class="form-input choice-input" 
                                           value="${choice.text}" 
                                           data-choice-id="${choice.id}"
                                           placeholder="ÏÑ†ÌÉùÏßÄ ${index + 1}">
                                    <input type="checkbox" class="choice-correct" 
                                           ${(Array.isArray(params.correctAnswer) ? params.correctAnswer.includes(choice.id) : params.correctAnswer === choice.id) ? 'checked' : ''}
                                           data-choice-id="${choice.id}">
                                    <button class="btn btn-danger" onclick="removeChoice('${choice.id}')">üóëÔ∏è</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="addChoice()">‚ûï ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="allow-multiple" ${params.allowMultiple ? 'checked' : ''}>
                            Îã§Ï§ë ÏÑ†ÌÉù ÌóàÏö©
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏãúÍ∞Ñ Ï†úÌïú (Ï¥à)</label>
                        <input type="number" class="form-input" id="time-limit" value="${params.timeLimit}" min="10" max="300">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ§Î™Ö</label>
                        <textarea class="form-input form-textarea" id="explanation" placeholder="Ï†ïÎãµ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${params.explanation}</textarea>
                    </div>
                </div>
            `;
        }
        
        // Îã®Ïñ¥ ÎßûÏ∂îÍ∏∞ Ìé∏ÏßëÍ∏∞
        function renderWordGuessEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">üî§ Îã®Ïñ¥ ÎßûÏ∂îÍ∏∞ Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">Ï†ïÎãµ Îã®Ïñ¥</label>
                        <input type="text" class="form-input" id="word" value="${params.word}" placeholder="Ï†ïÎãµ Îã®Ïñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÌûåÌä∏</label>
                        <textarea class="form-input form-textarea" id="hint" placeholder="ÌûåÌä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${params.hint}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                        <input type="text" class="form-input" id="category" value="${params.category}" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏµúÎåÄ ÏãúÎèÑ ÌöüÏàò</label>
                        <input type="number" class="form-input" id="max-attempts" value="${params.maxAttempts}" min="3" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏãúÍ∞Ñ Ï†úÌïú (Ï¥à)</label>
                        <input type="number" class="form-input" id="time-limit" value="${params.timeLimit}" min="30" max="300">
                    </div>
                </div>
            `;
        }
        
        // Î©îÎ™®Î¶¨ Í≤åÏûÑ Ìé∏ÏßëÍ∏∞
        function renderMemoryGameEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">üß† Î©îÎ™®Î¶¨ Í≤åÏûÑ Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">Í≤åÏûÑ Ï†úÎ™©</label>
                        <input type="text" class="form-input" id="game-title" value="${params.title}" placeholder="Í≤åÏûÑ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ïπ¥Îìú Ïåç</label>
                        <div id="card-builder">
                            ${renderCardPairs(params.cards)}
                        </div>
                        <button class="btn" onclick="addCardPair()">‚ûï Ïπ¥Îìú Ïåç Ï∂îÍ∞Ä</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏãúÍ∞Ñ Ï†úÌïú (Ï¥à)</label>
                        <input type="number" class="form-input" id="time-limit" value="${params.timeLimit}" min="30" max="600">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ±Í≥µ Î©îÏãúÏßÄ</label>
                        <input type="text" class="form-input" id="success-message" value="${params.successMessage}">
                    </div>
                </div>
            `;
        }
        
        // Ïπ¥Îìú Ïåç Î†åÎçîÎßÅ
        function renderCardPairs(cards) {
            const pairs = [];
            const processedMatchIds = new Set();
            
            cards.forEach(card => {
                if (!processedMatchIds.has(card.matchId)) {
                    const matchingCards = cards.filter(c => c.matchId === card.matchId);
                    if (matchingCards.length === 2) {
                        pairs.push(matchingCards);
                        processedMatchIds.add(card.matchId);
                    }
                }
            });
            
            return pairs.map((pair, index) => `
                <div class="card" style="margin-bottom: 1rem; background: #313244;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span>Ïπ¥Îìú Ïåç ${index + 1}</span>
                        <button class="btn btn-danger" onclick="removeCardPair('${pair[0].matchId}')">üóëÔ∏è ÏÇ≠Ï†ú</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Ïπ¥Îìú A</label>
                            <input type="text" class="form-input" value="${pair[0].content}" 
                                   data-match-id="${pair[0].matchId}" data-card-index="0">
                        </div>
                        <div>
                            <label class="form-label">Ïπ¥Îìú B</label>
                            <input type="text" class="form-input" value="${pair[1].content}" 
                                   data-match-id="${pair[0].matchId}" data-card-index="1">
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ÎπÑÎîîÏò§ Ìé∏ÏßëÍ∏∞
        function renderVideoEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">üé• ÎπÑÎîîÏò§ ÌôúÎèô Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">Ï†úÎ™©</label>
                        <input type="text" class="form-input" id="video-title" value="${params.title}" placeholder="ÎπÑÎîîÏò§ Ï†úÎ™©">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÎπÑÎîîÏò§ URL</label>
                        <input type="url" class="form-input" id="video-src" value="${params.src}" placeholder="https://example.com/video.mp4">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ§Î™Ö</label>
                        <textarea class="form-input form-textarea" id="video-description" placeholder="ÎπÑÎîîÏò§ ÏÑ§Î™Ö">${params.description}</textarea>
                    </div>
                </div>
            `;
        }
        
        // ÌÄ¥Ï¶à Ìé∏ÏßëÍ∏∞
        function renderQuizEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">‚ùì ÌÄ¥Ï¶à Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏßàÎ¨∏</label>
                        <textarea class="form-input form-textarea" id="question" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${params.question}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ†ÌÉùÏßÄ</label>
                        ${params.choices.map((choice, index) => `
                            <input type="text" class="form-input" style="margin-bottom: 0.5rem;" 
                                   value="${choice}" data-choice-index="${index}" placeholder="ÏÑ†ÌÉùÏßÄ ${index + 1}">
                        `).join('')}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ï†ïÎãµ</label>
                        <input type="text" class="form-input" id="correct-answer" value="${params.correct}" placeholder="Ï†ïÎãµ">
                    </div>
                </div>
            `;
        }
        
        // Survey Ìé∏ÏßëÍ∏∞ - ÏÉàÎ°úÏö¥ ÌÖúÌîåÎ¶ø!
        function renderSurveyEditor(activity) {
            const params = activity.params;
            
            return `
                <div class="card">
                    <div class="card-title">üìã ÏÑ§Î¨∏Ï°∞ÏÇ¨ Ìé∏Ïßë</div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏßàÎ¨∏ Î™©Î°ù</label>
                        <div id="survey-questions">
                            ${params.questions.map((question, index) => `
                                <div class="card" style="margin-bottom: 1rem; background: #313244;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <span>ÏßàÎ¨∏ ${index + 1}</span>
                                        <button class="btn btn-danger" onclick="removeSurveyQuestion(${index})">üóëÔ∏è ÏÇ≠Ï†ú</button>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">ÏßàÎ¨∏ Ïú†Ìòï</label>
                                        <select class="form-select" data-question-index="${index}" onchange="updateQuestionType(${index}, this.value)">
                                            <option value="multiple-choice" ${question.type === 'multiple-choice' ? 'selected' : ''}>Í∞ùÍ¥ÄÏãù</option>
                                            <option value="rating" ${question.type === 'rating' ? 'selected' : ''}>ÌèâÏ†ê</option>
                                            <option value="text" ${question.type === 'text' ? 'selected' : ''}>Ï£ºÍ¥ÄÏãù</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">ÏßàÎ¨∏</label>
                                        <textarea class="form-input" data-question-index="${index}" 
                                                 placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${question.question}</textarea>
                                    </div>
                                    
                                    ${question.type === 'multiple-choice' ? `
                                        <div class="form-group">
                                            <label class="form-label">ÏÑ†ÌÉùÏßÄ</label>
                                            ${question.options.map((option, oIndex) => `
                                                <input type="text" class="form-input" style="margin-bottom: 0.5rem;" 
                                                       value="${option}" 
                                                       data-question-index="${index}" 
                                                       data-option-index="${oIndex}" 
                                                       placeholder="ÏÑ†ÌÉùÏßÄ ${oIndex + 1}">
                                            `).join('')}
                                            <button class="btn" onclick="addSurveyOption(${index})">‚ûï ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä</button>
                                        </div>
                                    ` : ''}
                                    
                                    ${question.type === 'rating' ? `
                                        <div class="form-group">
                                            <label class="form-label">ÌèâÏ†ê Î≤îÏúÑ (1-10)</label>
                                            <input type="number" class="form-input" 
                                                   value="${question.scale || 5}" 
                                                   data-question-index="${index}"
                                                   data-field="scale" min="3" max="10">
                                        </div>
                                    ` : ''}
                                    
                                    <div class="form-group">
                                        <label class="form-label">
                                            <input type="checkbox" ${question.required ? 'checked' : ''} 
                                                   data-question-index="${index}" data-field="required">
                                            ÌïÑÏàò ÏßàÎ¨∏
                                        </label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn" onclick="addSurveyQuestion()">‚ûï ÏßàÎ¨∏ Ï∂îÍ∞Ä</button>
                    </div>
                </div>
            `;
        }
        
        // Ïô∏Î∂Ä ÌîåÎü¨Í∑∏Ïù∏ ÏóêÎîîÌÑ∞ (JSON Í∏∞Î∞ò)
        function renderExternalPluginEditor(activity, title) {
            return `
                <div class="card">
                    <div class="card-title">${title}</div>
                    
                    <div class="form-group">
                        <label class="form-label">ÌååÎùºÎØ∏ÌÑ∞ (JSON)</label>
                        <p style="color: #a6adc8; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Ïô∏Î∂Ä ÌîåÎü¨Í∑∏Ïù∏ ÌååÎùºÎØ∏ÌÑ∞Î•º JSON ÌòïÏãùÏúºÎ°ú Ìé∏ÏßëÌïòÏÑ∏Ïöî. 
                            <a href="plugins/README-${activity.template.split('@')[0].toUpperCase().replace(/-/g, '-')}.md" 
                               target="_blank" style="color: #89b4fa;">
                               üìñ Î¨∏ÏÑú Î≥¥Í∏∞
                            </a>
                        </p>
                        <textarea class="form-input form-textarea" 
                                  id="plugin-params-json" 
                                  rows="20"
                                  style="font-family: 'Courier New', monospace; font-size: 0.9rem;"
                                  placeholder="JSON ÌååÎùºÎØ∏ÌÑ∞Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">${JSON.stringify(activity.params, null, 2)}</textarea>
                        <div id="json-validation-error" style="color: #f38ba8; margin-top: 0.5rem; display: none;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥</label>
                        <div style="background: #45475a; padding: 1rem; border-radius: 8px;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>ÌÖúÌîåÎ¶ø:</strong> ${activity.template}
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Activity ID:</strong> ${activity.activityId}
                            </div>
                            <div>
                                <strong>ÌÉÄÏûÖ:</strong> Ïô∏Î∂Ä ÌîåÎü¨Í∑∏Ïù∏
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="validateAndUpdatePluginParams()">‚úÖ ÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©</button>
                </div>
            `;
        }
        
        // ÌîåÎü¨Í∑∏Ïù∏ ÌååÎùºÎØ∏ÌÑ∞ Í≤ÄÏ¶ù Î∞è ÏóÖÎç∞Ïù¥Ìä∏
        function validateAndUpdatePluginParams() {
            const jsonTextarea = document.getElementById('plugin-params-json');
            const errorDiv = document.getElementById('json-validation-error');
            
            try {
                const params = JSON.parse(jsonTextarea.value);
                
                // ÌòÑÏû¨ ÌôúÎèô ÏóÖÎç∞Ïù¥Ìä∏
                if (currentActivity) {
                    currentActivity.params = params;
                    errorDiv.style.display = 'none';
                    updateJsonPreview();
                    
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    errorDiv.textContent = '‚úÖ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.';
                    errorDiv.style.color = '#a6e3a1';
                    errorDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                errorDiv.textContent = '‚ùå JSON ÌååÏã± Ïò§Î•ò: ' + error.message;
                errorDiv.style.color = '#f38ba8';
                errorDiv.style.display = 'block';
            }
        }
        
        // Ìé∏ÏßëÍ∏∞ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
        function attachEditorEvents() {
            // Î™®Îì† ÏûÖÎ†• ÌïÑÎìúÏóê change Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
            const inputs = document.querySelectorAll('#edit-tab input, #edit-tab textarea, #edit-tab select');
            inputs.forEach(input => {
                input.addEventListener('input', updateActivityFromEditor);
                input.addEventListener('change', updateActivityFromEditor);
            });
        }
        
        // Ìé∏ÏßëÍ∏∞ÏóêÏÑú ÌôúÎèô ÏóÖÎç∞Ïù¥Ìä∏
        function updateActivityFromEditor() {
            if (selectedActivityIndex < 0) return;
            
            const activity = activities[selectedActivityIndex];
            const templateType = activity.template.split('@')[0];
            
            switch (templateType) {
                case 'multiple-choice':
                    updateMultipleChoiceActivity(activity);
                    break;
                case 'word-guess':
                    updateWordGuessActivity(activity);
                    break;
                case 'memory-game':
                    updateMemoryGameActivity(activity);
                    break;
                case 'video':
                    updateVideoActivity(activity);
                    break;
                case 'quiz':
                    updateQuizActivity(activity);
                    break;
                case 'survey':
                    updateSurveyActivity(activity);
                    break;
            }
            
            renderActivityList();
            updateJsonPreview();
            updateButtonStates();
        }
        
        // 4ÏßÄ ÏÑ†Îã§Ìòï ÏóÖÎç∞Ïù¥Ìä∏
        function updateMultipleChoiceActivity(activity) {
            const question = document.getElementById('question')?.value || '';
            const timeLimit = parseInt(document.getElementById('time-limit')?.value) || 30;
            const explanation = document.getElementById('explanation')?.value || '';
            const allowMultiple = document.getElementById('allow-multiple')?.checked || false;
            
            // ÏÑ†ÌÉùÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const choiceInputs = document.querySelectorAll('.choice-input');
            const choiceChecks = document.querySelectorAll('.choice-correct');
            const choices = [];
            const correctAnswers = [];
            
            choiceInputs.forEach((input, index) => {
                const choiceId = input.dataset.choiceId;
                const text = input.value;
                const isCorrect = choiceChecks[index]?.checked;
                
                choices.push({ id: choiceId, text: text });
                if (isCorrect) {
                    correctAnswers.push(choiceId);
                }
            });
            
            activity.params = {
                ...activity.params,
                question: question,
                choices: choices,
                correctAnswer: allowMultiple ? correctAnswers : correctAnswers[0] || choices[0]?.id,
                allowMultiple: allowMultiple,
                timeLimit: timeLimit,
                explanation: explanation
            };
        }
        
        // Îã®Ïñ¥ ÎßûÏ∂îÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateWordGuessActivity(activity) {
            activity.params = {
                ...activity.params,
                word: document.getElementById('word')?.value || '',
                hint: document.getElementById('hint')?.value || '',
                category: document.getElementById('category')?.value || '',
                maxAttempts: parseInt(document.getElementById('max-attempts')?.value) || 6,
                timeLimit: parseInt(document.getElementById('time-limit')?.value) || 120
            };
        }
        
        // Î©îÎ™®Î¶¨ Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMemoryGameActivity(activity) {
            const title = document.getElementById('game-title')?.value || '';
            const timeLimit = parseInt(document.getElementById('time-limit')?.value) || 120;
            const successMessage = document.getElementById('success-message')?.value || '';
            
            // Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
            const cardInputs = document.querySelectorAll('#card-builder input[data-match-id]');
            const cards = [];
            
            cardInputs.forEach((input, index) => {
                const matchId = input.dataset.matchId;
                const cardIndex = input.dataset.cardIndex;
                const content = input.value;
                
                cards.push({
                    id: `card-${matchId}-${cardIndex}`,
                    content: content,
                    type: 'text',
                    matchId: matchId
                });
            });
            
            activity.params = {
                ...activity.params,
                title: title,
                cards: cards,
                timeLimit: timeLimit,
                successMessage: successMessage
            };
        }
        
        // ÎπÑÎîîÏò§ ÏóÖÎç∞Ïù¥Ìä∏
        function updateVideoActivity(activity) {
            activity.params = {
                ...activity.params,
                title: document.getElementById('video-title')?.value || '',
                src: document.getElementById('video-src')?.value || '',
                description: document.getElementById('video-description')?.value || ''
            };
        }
        
        // ÌÄ¥Ï¶à ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuizActivity(activity) {
            const question = document.getElementById('question')?.value || '';
            const correctAnswer = document.getElementById('correct-answer')?.value || '';
            const choiceInputs = document.querySelectorAll('[data-choice-index]');
            const choices = [];
            
            choiceInputs.forEach(input => {
                choices.push(input.value);
            });
            
            activity.params = {
                ...activity.params,
                question: question,
                choices: choices,
                correct: correctAnswer
            };
        }
        
        // Survey ÏóÖÎç∞Ïù¥Ìä∏ - ÏÉàÎ°úÏö¥ ÌÖúÌîåÎ¶ø!
        function updateSurveyActivity(activity) {
            const questions = [];
            const questionElements = document.querySelectorAll('#survey-questions .card');
            
            questionElements.forEach((element, index) => {
                const questionText = element.querySelector(`textarea[data-question-index="${index}"]`)?.value || '';
                const questionType = element.querySelector(`select[data-question-index="${index}"]`)?.value || 'multiple-choice';
                const required = element.querySelector(`input[data-question-index="${index}"][data-field="required"]`)?.checked || false;
                
                const question = {
                    type: questionType,
                    question: questionText,
                    required: required
                };
                
                if (questionType === 'multiple-choice') {
                    const optionInputs = element.querySelectorAll(`input[data-question-index="${index}"][data-option-index]`);
                    question.options = Array.from(optionInputs).map(input => input.value);
                } else if (questionType === 'rating') {
                    const scaleInput = element.querySelector(`input[data-question-index="${index}"][data-field="scale"]`);
                    question.scale = parseInt(scaleInput?.value) || 5;
                    question.scaleLabels = ['Îß§Ïö∞ ÎÇòÏÅ®', 'Îß§Ïö∞ Ï¢ãÏùå'];
                }
                
                questions.push(question);
            });
            
            activity.params = {
                ...activity.params,
                questions: questions
            };
        }
        
        // ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä
        window.addChoice = function() {
            const choiceBuilder = document.getElementById('choice-builder');
            const choiceCount = choiceBuilder.children.length;
            const choiceId = `choice-${String.fromCharCode(97 + choiceCount)}`;
            
            const choiceHtml = `
                <div class="choice-item">
                    <input type="text" class="form-input choice-input" 
                           value="ÏÉà ÏÑ†ÌÉùÏßÄ" 
                           data-choice-id="${choiceId}"
                           placeholder="ÏÑ†ÌÉùÏßÄ ${choiceCount + 1}">
                    <input type="checkbox" class="choice-correct" 
                           data-choice-id="${choiceId}">
                    <button class="btn btn-danger" onclick="removeChoice('${choiceId}')">üóëÔ∏è</button>
                </div>
            `;
            
            choiceBuilder.insertAdjacentHTML('beforeend', choiceHtml);
            attachEditorEvents();
        };
        
        // ÏÑ†ÌÉùÏßÄ Ï†úÍ±∞
        window.removeChoice = function(choiceId) {
            const choiceItem = document.querySelector(`[data-choice-id="${choiceId}"]`).parentElement;
            choiceItem.remove();
            updateActivityFromEditor();
        };
        
        // Ïπ¥Îìú Ïåç Ï∂îÍ∞Ä
        window.addCardPair = function() {
            const cardBuilder = document.getElementById('card-builder');
            const pairCount = cardBuilder.children.length;
            const matchId = `pair-${pairCount + 1}`;
            
            const pairHtml = `
                <div class="card" style="margin-bottom: 1rem; background: #313244;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span>Ïπ¥Îìú Ïåç ${pairCount + 1}</span>
                        <button class="btn btn-danger" onclick="removeCardPair('${matchId}')">üóëÔ∏è ÏÇ≠Ï†ú</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Ïπ¥Îìú A</label>
                            <input type="text" class="form-input" value="Ïπ¥Îìú A" 
                                   data-match-id="${matchId}" data-card-index="0">
                        </div>
                        <div>
                            <label class="form-label">Ïπ¥Îìú B</label>
                            <input type="text" class="form-input" value="Ïπ¥Îìú B" 
                                   data-match-id="${matchId}" data-card-index="1">
                        </div>
                    </div>
                </div>
            `;
            
            cardBuilder.insertAdjacentHTML('beforeend', pairHtml);
            attachEditorEvents();
        };
        
        // Ïπ¥Îìú Ïåç Ï†úÍ±∞
        window.removeCardPair = function(matchId) {
            const pairElement = document.querySelector(`[data-match-id="${matchId}"]`).closest('.card');
            pairElement.remove();
            updateActivityFromEditor();
        };
        
        // Survey Ìé∏Ïßë ÎèÑÏö∞ÎØ∏ Ìï®ÏàòÎì§ - ÏÉàÎ°úÏö¥ ÌÖúÌîåÎ¶ø!
        window.addSurveyQuestion = function() {
            const activity = activities[selectedActivityIndex];
            activity.params.questions.push({
                type: 'multiple-choice',
                question: 'ÏÉà ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
                options: ['ÏòµÏÖò 1', 'ÏòµÏÖò 2'],
                required: true
            });
            renderActivityEditor(activity);
            attachEditorEvents();
        };
        
        window.removeSurveyQuestion = function(index) {
            const activity = activities[selectedActivityIndex];
            activity.params.questions.splice(index, 1);
            renderActivityEditor(activity);
            attachEditorEvents();
        };
        
        window.addSurveyOption = function(questionIndex) {
            const activity = activities[selectedActivityIndex];
            activity.params.questions[questionIndex].options.push('ÏÉà ÏòµÏÖò');
            renderActivityEditor(activity);
            attachEditorEvents();
        };
        
        window.updateQuestionType = function(index, newType) {
            const activity = activities[selectedActivityIndex];
            const question = activity.params.questions[index];
            
            question.type = newType;
            
            // ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            if (newType === 'multiple-choice' && !question.options) {
                question.options = ['ÏòµÏÖò 1', 'ÏòµÏÖò 2'];
            } else if (newType === 'rating' && !question.scale) {
                question.scale = 5;
                question.scaleLabels = ['Îß§Ïö∞ ÎÇòÏÅ®', 'Îß§Ïö∞ Ï¢ãÏùå'];
            }
            
            renderActivityEditor(activity);
            attachEditorEvents();
        };
        
        // ÌôúÎèô ÏÇ≠Ï†ú
        function deleteActivity() {
            if (selectedActivityIndex < 0) return;
            
            if (confirm('Ïù¥ ÌôúÎèôÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                activities.splice(selectedActivityIndex, 1);
                currentLesson.flow.splice(selectedActivityIndex, 1);
                
                selectedActivityIndex = -1;
                renderActivityList();
                hideActivityEditor();
                updateButtonStates();
                
                showNotification('ÌôúÎèôÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'warning');
            }
        }
        
        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(tabName) {
            // ÌÉ≠ ÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // ÏΩòÌÖêÏ∏† ÌëúÏãú
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // JSON ÌÉ≠Ïù∏ Í≤ΩÏö∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (tabName === 'json') {
                updateJsonPreview();
            }
        }
        
        // JSON ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateJsonPreview() {
            if (selectedActivityIndex >= 0) {
                const jsonPreview = document.getElementById('json-preview');
                if (jsonPreview) {
                    jsonPreview.textContent = JSON.stringify(activities[selectedActivityIndex], null, 2);
                }
            }
        }
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateButtonStates() {
            const hasTitle = currentLesson.title.trim().length > 0;
            const hasActivities = activities.length > 0;
            
            saveLessonBtn.disabled = !(hasTitle && hasActivities);
            previewLessonBtn.disabled = !(hasTitle && hasActivities);
            exportJsonBtn.disabled = !(hasTitle && hasActivities);
        }
        
        // Î†àÏä® Ï†ÄÏû•
        function saveLesson() {
            try {
                currentLesson.flow = activities;
                currentLesson.metadata.createdAt = new Date().toISOString();
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                const savedLessons = JSON.parse(localStorage.getItem('savedLessons') || '[]');
                const existingIndex = savedLessons.findIndex(lesson => lesson.lessonId === currentLesson.lessonId);
                
                if (existingIndex >= 0) {
                    savedLessons[existingIndex] = currentLesson;
                    showNotification('Î†àÏä®Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    savedLessons.push(currentLesson);
                    showNotification('Î†àÏä®Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
                
                localStorage.setItem('savedLessons', JSON.stringify(savedLessons));
                
            } catch (error) {
                console.error('Î†àÏä® Ï†ÄÏû• Ïò§Î•ò:', error);
                showNotification('Î†àÏä® Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        }
        
        // Î†àÏä® ÎØ∏Î¶¨Î≥¥Í∏∞
        function previewLesson() {
            currentLesson.flow = activities;
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï∞Ω Ïó¥Í∏∞
            const previewWindow = window.open('', '_blank', 'width=1200,height=800');
            previewWindow.document.write(`
                <html>
                    <head>
                        <title>Î†àÏä® ÎØ∏Î¶¨Î≥¥Í∏∞: ${currentLesson.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .preview-header { background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                            .activity { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
                            .activity-type { color: #666; font-size: 12px; text-transform: uppercase; font-weight: bold; }
                            .activity-title { font-size: 18px; font-weight: bold; margin: 10px 0; }
                            .choices { margin: 10px 0; }
                            .choice { background: #f9f9f9; padding: 8px; margin: 5px 0; border-radius: 4px; }
                            .correct { background: #d4edda; }
                        </style>
                    </head>
                    <body>
                        <div class="preview-header">
                            <h1>${currentLesson.title}</h1>
                            <p>${currentLesson.description}</p>
                            <small>ÎÇúÏù¥ÎèÑ: ${currentLesson.metadata.difficulty} | ÏòàÏÉÅ ÏãúÍ∞Ñ: ${currentLesson.metadata.estimatedTime}Î∂Ñ</small>
                        </div>
                        
                        ${activities.map((activity, index) => {
                            const templateType = activity.template.split('@')[0];
                            return `
                                <div class="activity">
                                    <div class="activity-type">${templateType}</div>
                                    <div class="activity-title">ÌôúÎèô ${index + 1}: ${activity.params.question || activity.params.title || activity.activityId}</div>
                                    ${renderActivityPreview(activity)}
                                </div>
                            `;
                        }).join('')}
                    </body>
                </html>
            `);
        }
        
        // ÌôúÎèô ÎØ∏Î¶¨Î≥¥Í∏∞ Î†åÎçîÎßÅ
        function renderActivityPreview(activity) {
            const templateType = activity.template.split('@')[0];
            const params = activity.params;
            
            switch (templateType) {
                case 'multiple-choice':
                    return `
                        <div class="choices">
                            ${params.choices.map(choice => {
                                const isCorrect = Array.isArray(params.correctAnswer) 
                                    ? params.correctAnswer.includes(choice.id)
                                    : params.correctAnswer === choice.id;
                                return `<div class="choice ${isCorrect ? 'correct' : ''}">${choice.text} ${isCorrect ? '(Ï†ïÎãµ)' : ''}</div>`;
                            }).join('')}
                        </div>
                        ${params.explanation ? `<p><strong>ÏÑ§Î™Ö:</strong> ${params.explanation}</p>` : ''}
                    `;
                    
                case 'word-guess':
                    return `
                        <p><strong>Ï†ïÎãµ:</strong> ${params.word}</p>
                        <p><strong>ÌûåÌä∏:</strong> ${params.hint}</p>
                        <p><strong>Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${params.category}</p>
                        <p><strong>ÏµúÎåÄ ÏãúÎèÑ:</strong> ${params.maxAttempts}Ìöå</p>
                    `;
                    
                case 'memory-game':
                    const pairs = [];
                    const processedMatchIds = new Set();
                    
                    params.cards.forEach(card => {
                        if (!processedMatchIds.has(card.matchId)) {
                            const matchingCards = params.cards.filter(c => c.matchId === card.matchId);
                            if (matchingCards.length === 2) {
                                pairs.push(matchingCards);
                                processedMatchIds.add(card.matchId);
                            }
                        }
                    });
                    
                    return `
                        <div class="choices">
                            ${pairs.map((pair, index) => 
                                `<div class="choice">Ïåç ${index + 1}: "${pair[0].content}" ‚Üî "${pair[1].content}"</div>`
                            ).join('')}
                        </div>
                    `;
                    
                case 'video':
                    return `
                        <p><strong>ÎπÑÎîîÏò§ URL:</strong> ${params.src}</p>
                        <p>${params.description}</p>
                    `;
                    
                case 'quiz':
                    return `
                        <div class="choices">
                            ${params.choices.map(choice => 
                                `<div class="choice ${choice === params.correct ? 'correct' : ''}">${choice} ${choice === params.correct ? '(Ï†ïÎãµ)' : ''}</div>`
                            ).join('')}
                        </div>
                    `;
                    
                case 'survey':
                    return `
                        <div class="choices">
                            ${params.questions.map((question, index) => `
                                <div class="choice">
                                    <strong>Q${index + 1}:</strong> ${question.question} 
                                    <span style="color: #fab387;">[${question.type}]</span>
                                    ${question.required ? ' <span style="color: #f38ba8;">*</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                default:
                    return '<p>ÎØ∏Î¶¨Î≥¥Í∏∞Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>';
            }
        }
        
        // JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportJson() {
            currentLesson.flow = activities;
            const jsonData = JSON.stringify(currentLesson, null, 2);
            
            // ÌååÏùº Îã§Ïö¥Î°úÎìú
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentLesson.lessonId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('JSON ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        // ÏïåÎ¶º ÌëúÏãú
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Ï¥àÍ∏∞Ìôî
        console.log('üìö Î†àÏä® ÎπåÎçîÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!');
        updateButtonStates();
    </script>
</body>
</html>