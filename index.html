<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>교육용 레슨 플랫폼 - 새로운 안전한 구조</title>
  <style>
    /* 기본 변수 정의 */
    :root {
      --primary: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #475569;
      --border-light: #334155;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* 기본 리셋 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* 메인 레이아웃 */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 헤더 */
    .header {
      height: 60px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-right: 20px;
    }

    .nav-tabs {
      display: flex;
      gap: 4px;
    }

    .nav-tab {
      padding: 8px 16px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* 메인 컨텐츠 영역 */
    .main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* 사이드바 */
    .sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* 컨텐츠 영역 */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .content-panel {
      display: none;
      flex: 1;
      min-height: 0;
    }

    .content-panel.active {
      display: flex;
      flex-direction: column;
    }

    /* 플레이어 패널 */
    .player-panel {
      padding: 20px;
      gap: 20px;
    }

    .player-header {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .lesson-info h2 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .lesson-meta {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .progress-bar {
      width: 200px;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* 활동 컨테이너 - 가장 중요한 부분 */
    .activity-container {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin: 20px 0;
      padding: 24px;
      min-height: 400px;
      height: calc(100vh - 300px); /* 고정된 계산된 높이 */
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .activity-placeholder {
      text-align: center;
      color: var(--text-muted);
      font-size: 16px;
    }

    .activity-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 300px;
    }

    /* 플레이어 컨트롤 */
    .player-controls {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .control-group {
      display: flex;
      gap: 8px;
    }

    /* 빌더 패널 */
    .builder-panel {
      padding: 20px;
      gap: 20px;
    }

    .builder-toolbar {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-radius: 8px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }

    .builder-workspace {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      min-height: 500px;
      overflow-y: auto;
    }

    /* 버튼 스타일 */
    .btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--secondary);
      border-color: var(--secondary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 폼 요소 */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .form-select, .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* 카드 스타일 */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    /* 레슨 목록 */
    .lesson-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lesson-item {
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lesson-item:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    .lesson-title {
      font-weight: 500;
      color: var(--text-primary);
    }

    .lesson-meta-small {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* 템플릿 컨테이너 */
    .template-video {
      width: 100%;
      max-width: 600px;
      background: black;
      border-radius: 8px;
      margin: 0 auto;
    }

    .template-video video {
      width: 100%;
      height: auto;
      max-height: 400px;
      border-radius: 8px;
    }

    .template-drag-drop {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }

    .prompt-text {
      font-size: 20px;
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-primary);
    }

    .drop-zone {
      min-height: 80px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      transition: all 0.2s;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 16px;
    }

    .drop-zone.drag-over {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .choices-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    .choice-item {
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
      transition: all 0.2s;
      font-weight: 500;
    }

    .choice-item:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .choice-item:active {
      cursor: grabbing;
    }

    /* 알림 메시지 */
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      min-width: 250px;
      animation: slideIn 0.3s ease;
    }

    .notification.success {
      background: var(--secondary);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--primary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* 로딩 상태 */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 팝업 플레이어 스타일 */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .popup-overlay.active {
      display: flex;
    }

    .popup-player {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      height: 90%;
      max-height: 600px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .popup-header {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .popup-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .popup-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .popup-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .popup-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .popup-activity-area {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      background: var(--bg-secondary);
      margin: 20px;
      border-radius: 8px;
    }

    .popup-controls {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .popup-progress {
      flex: 1;
      margin: 0 20px;
    }

    .popup-progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .popup-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -320px;
        top: 60px;
        height: calc(100vh - 60px);
        z-index: 100;
        transition: left 0.3s ease;
      }

      .sidebar.open {
        left: 0;
      }

      .activity-container {
        height: calc(100vh - 260px);
        max-height: calc(100vh - 260px);
      }

      .player-controls {
        flex-direction: column;
        gap: 12px;
      }

      .control-group {
        width: 100%;
        justify-content: center;
      }

      .popup-player {
        width: 95%;
        height: 95%;
        max-height: 95vh;
      }

      .popup-controls {
        flex-direction: column;
        gap: 12px;
      }

      .popup-progress {
        order: -1;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- 헤더 -->
    <header class="header">
      <h1>교육용 레슨 플랫폼</h1>
      <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="player">플레이어</button>
        <button class="nav-tab" data-tab="builder">빌더</button>
      </nav>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="main">
      <!-- 사이드바 -->
      <aside class="sidebar">
        <div class="sidebar-content">
          <!-- 플레이어 사이드바 -->
          <div id="player-sidebar" class="sidebar-panel">
            <div class="card">
              <div class="card-title">레슨 로드</div>
              
              <div class="form-group">
                <label class="form-label">샘플 레슨 선택</label>
                <select class="form-select" id="lesson-select">
                  <option value="">-- 레슨을 선택하세요 --</option>
                  <option value="sample1">기초 영어 회화</option>
                  <option value="sample2">수학 기초 연산</option>
                  <option value="sample3">과학 실험</option>
                </select>
              </div>

              <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" id="load-lesson-btn" disabled>
                  레슨 로드
                </button>
                <button class="btn btn-secondary" id="popup-player-btn" disabled>
                  팝업 플레이어
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">파일 업로드</div>
              <input type="file" class="form-input" id="file-input" accept=".json">
            </div>

            <!-- 현재 레슨 정보 -->
            <div class="card" id="current-lesson-info" style="display: none;">
              <div class="card-title">현재 레슨</div>
              <div id="lesson-details">
                <div class="lesson-title" id="current-lesson-title">-</div>
                <div class="lesson-meta-small" id="current-lesson-meta">-</div>
              </div>
            </div>
          </div>

          <!-- 빌더 사이드바 -->
          <div id="builder-sidebar" class="sidebar-panel" style="display: none;">
            <div class="card">
              <div class="card-title">템플릿 라이브러리</div>
              <div class="lesson-list">
                <div class="lesson-item" data-template="video">
                  <div>
                    <div class="lesson-title">비디오 템플릿</div>
                    <div class="lesson-meta-small">영상 학습용</div>
                  </div>
                </div>
                <div class="lesson-item" data-template="drag-drop">
                  <div>
                    <div class="lesson-title">드래그앤드롭</div>
                    <div class="lesson-meta-small">상호작용 퀴즈</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- 컨텐츠 영역 -->
      <div class="content">
        <!-- 플레이어 패널 -->
        <div class="content-panel active player-panel" id="player-panel">
          <!-- 플레이어 헤더 -->
          <div class="player-header">
            <div class="lesson-info">
              <h2 id="player-lesson-title">레슨을 선택해주세요</h2>
              <div class="lesson-meta">
                <span id="activity-counter">0 / 0</span> •
                <span id="current-template">템플릿 없음</span>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>

          <!-- 활동 컨테이너 -->
          <div class="activity-container" id="activity-container">
            <div class="activity-placeholder">
              <p>좌측에서 레슨을 선택하여 시작하세요</p>
            </div>
          </div>

          <!-- 플레이어 컨트롤 -->
          <div class="player-controls">
            <div class="control-group">
              <button class="btn" id="prev-btn" disabled>이전</button>
              <button class="btn btn-primary" id="next-btn" disabled>다음</button>
            </div>
            <div class="control-group">
              <button class="btn btn-secondary" id="restart-btn" disabled>재시작</button>
              <button class="btn btn-danger" id="finish-btn" disabled>종료</button>
            </div>
          </div>
        </div>

        <!-- 빌더 패널 -->
        <div class="content-panel builder-panel" id="builder-panel">
          <!-- 빌더 툴바 -->
          <div class="builder-toolbar">
            <button class="btn btn-primary">새 레슨</button>
            <button class="btn">저장</button>
            <button class="btn">미리보기</button>
          </div>

          <!-- 빌더 작업공간 -->
          <div class="builder-workspace">
            <div class="activity-placeholder">
              <p>레슨 빌더 작업공간</p>
              <p>좌측에서 템플릿을 선택하여 시작하세요</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 팝업 플레이어 -->
  <div class="popup-overlay" id="popup-overlay">
    <div class="popup-player">
      <div class="popup-header">
        <h3 class="popup-title" id="popup-lesson-title">팝업 플레이어</h3>
        <button class="popup-close" id="popup-close">×</button>
      </div>
      
      <div class="popup-content">
        <div class="popup-activity-area" id="popup-activity-area">
          <div class="activity-placeholder">
            <p>팝업 플레이어가 준비되었습니다.</p>
            <p>레슨을 시작하려면 아래 컨트롤을 사용하세요.</p>
          </div>
        </div>
      </div>

      <div class="popup-controls">
        <div class="control-group">
          <button class="btn" id="popup-prev-btn" disabled>이전</button>
          <button class="btn btn-primary" id="popup-next-btn" disabled>다음</button>
        </div>
        
        <div class="popup-progress">
          <div class="popup-progress-bar">
            <div class="popup-progress-fill" id="popup-progress-fill"></div>
          </div>
        </div>

        <div class="control-group">
          <button class="btn btn-secondary" id="popup-restart-btn" disabled>재시작</button>
          <button class="btn btn-danger" id="popup-finish-btn" disabled>종료</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // 안전한 레슨 플랫폼 클래스
    class SafeLessonPlatform {
      constructor() {
        this.currentLesson = null;
        this.currentActivityIndex = 0;
        this.activities = [];
        this.results = [];
        
        this.init();
      }

      init() {
        this.setupNavigation();
        this.setupLessonLoader();
        this.setupPlayerControls();
        this.loadSampleLessons();
        
        console.log('✅ 안전한 레슨 플랫폼이 초기화되었습니다.');
      }

      // 네비게이션 설정
      setupNavigation() {
        const tabs = document.querySelectorAll('.nav-tab');
        const panels = document.querySelectorAll('.content-panel');
        const sidebars = document.querySelectorAll('.sidebar-panel');

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            
            // 탭 활성화
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // 패널 전환
            panels.forEach(panel => {
              panel.classList.remove('active');
              if (panel.id === `${targetTab}-panel`) {
                panel.classList.add('active');
              }
            });
            
            // 사이드바 전환
            sidebars.forEach(sidebar => {
              sidebar.style.display = 'none';
              if (sidebar.id === `${targetTab}-sidebar`) {
                sidebar.style.display = 'block';
              }
            });
          });
        });
      }

      // 레슨 로더 설정
      setupLessonLoader() {
        const select = document.getElementById('lesson-select');
        const loadBtn = document.getElementById('load-lesson-btn');
        const popupBtn = document.getElementById('popup-player-btn');
        const fileInput = document.getElementById('file-input');

        select.addEventListener('change', () => {
          const hasValue = !!select.value;
          loadBtn.disabled = !hasValue;
          popupBtn.disabled = !hasValue;
        });

        loadBtn.addEventListener('click', () => {
          this.loadLesson(select.value);
        });

        // 팝업 플레이어 버튼
        popupBtn.addEventListener('click', () => {
          this.openPopupPlayer(select.value);
        });

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            this.loadLessonFromFile(file);
          }
        });

        // 팝업 컨트롤 설정
        this.setupPopupControls();
      }

      // 플레이어 컨트롤 설정
      setupPlayerControls() {
        document.getElementById('prev-btn').addEventListener('click', () => {
          this.previousActivity();
        });
        
        document.getElementById('next-btn').addEventListener('click', () => {
          this.nextActivity();
        });
        
        document.getElementById('restart-btn').addEventListener('click', () => {
          this.restartLesson();
        });
        
        document.getElementById('finish-btn').addEventListener('click', () => {
          this.finishLesson();
        });
      }

      // 샘플 레슨 로드
      loadSampleLessons() {
        // 안전한 샘플 데이터
        this.sampleLessons = {
          sample1: {
            title: "기초 영어 회화",
            activities: [
              {
                type: "video",
                title: "인사말 배우기",
                content: {
                  src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
                  description: "기본 인사말을 배워보세요"
                }
              },
              {
                type: "drag-drop",
                title: "단어 맞추기",
                content: {
                  prompt: "알맞은 인사말을 선택하세요: Good ____",
                  choices: ["morning", "night", "bye", "hello"],
                  answer: "morning"
                }
              }
            ]
          },
          sample2: {
            title: "수학 기초 연산",
            activities: [
              {
                type: "drag-drop",
                title: "덧셈 문제",
                content: {
                  prompt: "2 + 3 = ?",
                  choices: ["4", "5", "6", "7"],
                  answer: "5"
                }
              }
            ]
          },
          sample3: {
            title: "과학 실험",
            activities: [
              {
                type: "video",
                title: "물의 순환",
                content: {
                  src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
                  description: "물의 순환 과정을 알아보세요"
                }
              }
            ]
          }
        };
      }

      // 레슨 로드
      async loadLesson(lessonId) {
        try {
          this.showNotification('레슨을 로드하고 있습니다...', 'info');
          
          const lesson = this.sampleLessons[lessonId];
          if (!lesson) {
            throw new Error('레슨을 찾을 수 없습니다.');
          }

          this.currentLesson = lesson;
          this.activities = lesson.activities;
          this.currentActivityIndex = 0;
          this.results = [];

          this.updateLessonInfo();
          this.loadActivity(0);
          this.updateControls();
          
          this.showNotification('레슨이 성공적으로 로드되었습니다.', 'success');
          
        } catch (error) {
          console.error('레슨 로드 실패:', error);
          this.showNotification('레슨 로드에 실패했습니다: ' + error.message, 'error');
        }
      }

      // 파일에서 레슨 로드
      async loadLessonFromFile(file) {
        try {
          const text = await file.text();
          const lessonData = JSON.parse(text);
          
          // 간단한 유효성 검사
          if (!lessonData.title || !lessonData.activities) {
            throw new Error('올바른 레슨 형식이 아닙니다.');
          }

          this.currentLesson = lessonData;
          this.activities = lessonData.activities;
          this.currentActivityIndex = 0;
          this.results = [];

          this.updateLessonInfo();
          this.loadActivity(0);
          this.updateControls();
          
          this.showNotification('파일에서 레슨이 로드되었습니다.', 'success');
          
        } catch (error) {
          console.error('파일 로드 실패:', error);
          this.showNotification('파일 로드에 실패했습니다: ' + error.message, 'error');
        }
      }

      // 레슨 정보 업데이트
      updateLessonInfo() {
        if (!this.currentLesson) return;

        document.getElementById('player-lesson-title').textContent = this.currentLesson.title;
        document.getElementById('current-lesson-title').textContent = this.currentLesson.title;
        document.getElementById('current-lesson-meta').textContent = `${this.activities.length}개 활동`;
        document.getElementById('current-lesson-info').style.display = 'block';
      }

      // 활동 로드
      loadActivity(index) {
        if (!this.activities || index < 0 || index >= this.activities.length) {
          return;
        }

        const activity = this.activities[index];
        const container = document.getElementById('activity-container');
        
        // 활동 카운터 업데이트
        document.getElementById('activity-counter').textContent = `${index + 1} / ${this.activities.length}`;
        document.getElementById('current-template').textContent = activity.type;
        
        // 진행률 업데이트
        const progress = ((index) / this.activities.length) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;

        try {
          // 안전한 템플릿 렌더링
          if (activity.type === 'video') {
            this.renderVideoActivity(container, activity);
          } else if (activity.type === 'drag-drop') {
            this.renderDragDropActivity(container, activity);
          } else {
            throw new Error(`지원하지 않는 활동 유형: ${activity.type}`);
          }
        } catch (error) {
          console.error('활동 로드 실패:', error);
          container.innerHTML = `
            <div class="activity-placeholder">
              <p>활동을 로드할 수 없습니다</p>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // 비디오 활동 렌더링
      renderVideoActivity(container, activity) {
        container.innerHTML = `
          <div class="activity-content">
            <div class="template-video">
              <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">
                ${activity.title}
              </h3>
              <video controls style="width: 100%; max-height: 400px; border-radius: 8px;">
                <source src="${activity.content.src}" type="video/mp4">
                이 브라우저는 비디오를 지원하지 않습니다.
              </video>
              <p style="text-align: center; margin-top: 16px; color: var(--text-secondary);">
                ${activity.content.description || '비디오를 시청하고 다음 버튼을 클릭하세요.'}
              </p>
            </div>
          </div>
        `;
      }

      // 드래그앤드롭 활동 렌더링
      renderDragDropActivity(container, activity) {
        container.innerHTML = `
          <div class="activity-content">
            <div class="template-drag-drop">
              <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">
                ${activity.title}
              </h3>
              <div class="prompt-text">${activity.content.prompt}</div>
              <div class="drop-zone" id="drop-zone">
                정답을 여기에 드래그하세요
              </div>
              <div class="choices-container" id="choices-container">
                ${activity.content.choices.map(choice => `
                  <div class="choice-item" draggable="true" data-choice="${choice}">
                    ${choice}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        // 드래그앤드롭 이벤트 설정
        this.setupDragAndDrop(activity.content.answer);
      }

      // 드래그앤드롭 이벤트 설정
      setupDragAndDrop(correctAnswer) {
        const dropZone = document.getElementById('drop-zone');
        const choices = document.querySelectorAll('.choice-item');

        choices.forEach(choice => {
          choice.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.choice);
          });
          
          // 클릭으로도 선택 가능
          choice.addEventListener('click', (e) => {
            const selectedChoice = e.target.dataset.choice;
            this.handleChoice(selectedChoice, correctAnswer, dropZone);
          });
        });

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const selectedChoice = e.dataTransfer.getData('text/plain');
          this.handleChoice(selectedChoice, correctAnswer, dropZone);
        });
      }

      // 선택 처리
      handleChoice(selectedChoice, correctAnswer, dropZone) {
        const isCorrect = selectedChoice === correctAnswer;
        
        dropZone.textContent = `선택됨: ${selectedChoice}`;
        dropZone.style.backgroundColor = isCorrect ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        dropZone.style.borderColor = isCorrect ? 'var(--secondary)' : 'var(--danger)';
        
        // 결과 저장
        this.results[this.currentActivityIndex] = {
          selected: selectedChoice,
          correct: correctAnswer,
          isCorrect: isCorrect,
          timestamp: Date.now()
        };

        if (isCorrect) {
          setTimeout(() => {
            this.showNotification('정답입니다!', 'success');
          }, 500);
        } else {
          setTimeout(() => {
            this.showNotification('다시 시도해보세요.', 'error');
          }, 500);
        }
      }

      // 이전 활동
      previousActivity() {
        if (this.currentActivityIndex > 0) {
          this.currentActivityIndex--;
          this.loadActivity(this.currentActivityIndex);
          this.updateControls();
        }
      }

      // 다음 활동
      nextActivity() {
        if (this.currentActivityIndex < this.activities.length - 1) {
          this.currentActivityIndex++;
          this.loadActivity(this.currentActivityIndex);
          this.updateControls();
        } else {
          this.finishLesson();
        }
      }

      // 레슨 재시작
      restartLesson() {
        if (confirm('레슨을 처음부터 다시 시작하시겠습니까?')) {
          this.currentActivityIndex = 0;
          this.results = [];
          this.loadActivity(0);
          this.updateControls();
          this.showNotification('레슨이 재시작되었습니다.', 'info');
        }
      }

      // 레슨 종료
      finishLesson() {
        const correctAnswers = this.results.filter(r => r && r.isCorrect).length;
        const totalAnswers = this.results.filter(r => r).length;
        const percentage = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;

        alert(`레슨 완료!
        
정답률: ${percentage}% (${correctAnswers}/${totalAnswers})
수고하셨습니다!`);

        // 초기 상태로 복원
        this.currentLesson = null;
        this.currentActivityIndex = 0;
        this.activities = [];
        this.results = [];
        
        document.getElementById('activity-container').innerHTML = `
          <div class="activity-placeholder">
            <p>좌측에서 레슨을 선택하여 시작하세요</p>
          </div>
        `;
        
        this.updateControls();
        document.getElementById('current-lesson-info').style.display = 'none';
      }

      // 컨트롤 상태 업데이트
      updateControls() {
        const hasLesson = this.currentLesson !== null;
        const hasPrevious = hasLesson && this.currentActivityIndex > 0;
        const hasNext = hasLesson && this.currentActivityIndex < this.activities.length - 1;

        document.getElementById('prev-btn').disabled = !hasPrevious;
        document.getElementById('next-btn').disabled = !hasNext;
        document.getElementById('restart-btn').disabled = !hasLesson;
        document.getElementById('finish-btn').disabled = !hasLesson;
      }

      // 팝업 컨트롤 설정
      setupPopupControls() {
        const overlay = document.getElementById('popup-overlay');
        const closeBtn = document.getElementById('popup-close');
        
        // 팝업 닫기
        closeBtn.addEventListener('click', () => {
          this.closePopupPlayer();
        });

        // 배경 클릭으로 닫기
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            this.closePopupPlayer();
          }
        });

        // ESC 키로 닫기
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && overlay.classList.contains('active')) {
            this.closePopupPlayer();
          }
        });

        // 팝업 플레이어 컨트롤
        document.getElementById('popup-prev-btn').addEventListener('click', () => {
          this.popupPreviousActivity();
        });
        
        document.getElementById('popup-next-btn').addEventListener('click', () => {
          this.popupNextActivity();
        });
        
        document.getElementById('popup-restart-btn').addEventListener('click', () => {
          this.popupRestartLesson();
        });
        
        document.getElementById('popup-finish-btn').addEventListener('click', () => {
          this.popupFinishLesson();
        });
      }

      // 팝업 플레이어 열기
      openPopupPlayer(lessonId) {
        try {
          const lesson = this.sampleLessons[lessonId];
          if (!lesson) {
            throw new Error('레슨을 찾을 수 없습니다.');
          }

          // 팝업용 상태 초기화
          this.popupLesson = lesson;
          this.popupActivityIndex = 0;
          this.popupResults = [];

          // 팝업 UI 업데이트
          document.getElementById('popup-lesson-title').textContent = lesson.title;
          
          // 팝업 표시
          document.getElementById('popup-overlay').classList.add('active');
          
          // 첫 번째 활동 로드
          this.loadPopupActivity(0);
          this.updatePopupControls();
          
          this.showNotification('팝업 플레이어에서 레슨을 시작합니다.', 'success');
          
        } catch (error) {
          console.error('팝업 플레이어 오류:', error);
          this.showNotification('팝업 플레이어를 열 수 없습니다: ' + error.message, 'error');
        }
      }

      // 팝업 플레이어 닫기
      closePopupPlayer() {
        document.getElementById('popup-overlay').classList.remove('active');
        
        // 상태 정리
        this.popupLesson = null;
        this.popupActivityIndex = 0;
        this.popupResults = [];
        
        // 팝업 내용 초기화
        document.getElementById('popup-activity-area').innerHTML = `
          <div class="activity-placeholder">
            <p>팝업 플레이어가 준비되었습니다.</p>
            <p>레슨을 시작하려면 아래 컨트롤을 사용하세요.</p>
          </div>
        `;
      }

      // 팝업 활동 로드
      loadPopupActivity(index) {
        if (!this.popupLesson || index < 0 || index >= this.popupLesson.activities.length) {
          return;
        }

        const activity = this.popupLesson.activities[index];
        const container = document.getElementById('popup-activity-area');
        
        // 진행률 업데이트
        const progress = ((index) / this.popupLesson.activities.length) * 100;
        document.getElementById('popup-progress-fill').style.width = `${progress}%`;

        try {
          // 팝업 전용 렌더링
          if (activity.type === 'video') {
            this.renderPopupVideoActivity(container, activity);
          } else if (activity.type === 'drag-drop') {
            this.renderPopupDragDropActivity(container, activity);
          } else {
            throw new Error(`지원하지 않는 활동 유형: ${activity.type}`);
          }
        } catch (error) {
          console.error('팝업 활동 로드 실패:', error);
          container.innerHTML = `
            <div class="activity-placeholder">
              <p style="color: var(--danger);">활동을 로드할 수 없습니다</p>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // 팝업용 비디오 활동 렌더링
      renderPopupVideoActivity(container, activity) {
        container.innerHTML = `
          <div style="width: 100%; text-align: center;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary);">
              ${activity.title}
            </h3>
            <video controls style="width: 100%; max-width: 500px; max-height: 300px; border-radius: 8px; background: black;">
              <source src="${activity.content.src}" type="video/mp4">
              이 브라우저는 비디오를 지원하지 않습니다.
            </video>
            <p style="margin-top: 16px; color: var(--text-secondary);">
              ${activity.content.description || '비디오를 시청하고 다음 버튼을 클릭하세요.'}
            </p>
          </div>
        `;
      }

      // 팝업용 드래그앤드롭 활동 렌더링
      renderPopupDragDropActivity(container, activity) {
        const popupId = 'popup-' + Date.now(); // 고유 ID 생성
        
        container.innerHTML = `
          <div style="width: 100%; max-width: 600px; text-align: center;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary);">
              ${activity.title}
            </h3>
            <div style="font-size: 18px; margin-bottom: 20px; color: var(--text-primary);">
              ${activity.content.prompt}
            </div>
            <div class="drop-zone" id="popup-drop-zone-${popupId}" style="margin-bottom: 20px; min-height: 60px; display: flex; align-items: center; justify-content: center;">
              정답을 여기에 드래그하세요
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;" id="popup-choices-${popupId}">
              ${activity.content.choices.map(choice => `
                <div class="choice-item" draggable="true" data-choice="${choice}" style="padding: 10px 16px; background: var(--primary); color: white; border-radius: 6px; cursor: pointer;">
                  ${choice}
                </div>
              `).join('')}
            </div>
          </div>
        `;

        // 팝업용 드래그앤드롭 이벤트 설정
        this.setupPopupDragAndDrop(popupId, activity.content.answer);
      }

      // 팝업용 드래그앤드롭 이벤트 설정
      setupPopupDragAndDrop(popupId, correctAnswer) {
        const dropZone = document.getElementById(`popup-drop-zone-${popupId}`);
        const choices = document.querySelectorAll(`#popup-choices-${popupId} .choice-item`);

        choices.forEach(choice => {
          choice.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.choice);
          });
          
          // 클릭으로도 선택 가능
          choice.addEventListener('click', (e) => {
            const selectedChoice = e.target.dataset.choice;
            this.handlePopupChoice(selectedChoice, correctAnswer, dropZone);
          });
        });

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const selectedChoice = e.dataTransfer.getData('text/plain');
          this.handlePopupChoice(selectedChoice, correctAnswer, dropZone);
        });
      }

      // 팝업 선택 처리
      handlePopupChoice(selectedChoice, correctAnswer, dropZone) {
        const isCorrect = selectedChoice === correctAnswer;
        
        dropZone.textContent = `선택됨: ${selectedChoice}`;
        dropZone.style.backgroundColor = isCorrect ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        dropZone.style.borderColor = isCorrect ? 'var(--secondary)' : 'var(--danger)';
        
        // 결과 저장
        this.popupResults[this.popupActivityIndex] = {
          selected: selectedChoice,
          correct: correctAnswer,
          isCorrect: isCorrect,
          timestamp: Date.now()
        };

        if (isCorrect) {
          setTimeout(() => {
            this.showNotification('정답입니다! 🎉', 'success');
          }, 500);
        } else {
          setTimeout(() => {
            this.showNotification('다시 시도해보세요. 🤔', 'error');
          }, 500);
        }
      }

      // 팝업 플레이어 네비게이션 메소드들
      popupPreviousActivity() {
        if (this.popupActivityIndex > 0) {
          this.popupActivityIndex--;
          this.loadPopupActivity(this.popupActivityIndex);
          this.updatePopupControls();
        }
      }

      popupNextActivity() {
        if (this.popupActivityIndex < this.popupLesson.activities.length - 1) {
          this.popupActivityIndex++;
          this.loadPopupActivity(this.popupActivityIndex);
          this.updatePopupControls();
        } else {
          this.popupFinishLesson();
        }
      }

      popupRestartLesson() {
        if (confirm('레슨을 처음부터 다시 시작하시겠습니까?')) {
          this.popupActivityIndex = 0;
          this.popupResults = [];
          this.loadPopupActivity(0);
          this.updatePopupControls();
          this.showNotification('팝업 레슨이 재시작되었습니다.', 'info');
        }
      }

      popupFinishLesson() {
        const correctAnswers = this.popupResults.filter(r => r && r.isCorrect).length;
        const totalAnswers = this.popupResults.filter(r => r).length;
        const percentage = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;

        setTimeout(() => {
          alert(`🎉 팝업 레슨 완료!
        
📊 결과:
정답률: ${percentage}% (${correctAnswers}/${totalAnswers})

수고하셨습니다! 👏`);

          this.closePopupPlayer();
        }, 100);
      }

      // 팝업 컨트롤 상태 업데이트
      updatePopupControls() {
        if (!this.popupLesson) return;

        const hasPrevious = this.popupActivityIndex > 0;
        const hasNext = this.popupActivityIndex < this.popupLesson.activities.length - 1;

        document.getElementById('popup-prev-btn').disabled = !hasPrevious;
        document.getElementById('popup-next-btn').disabled = !hasNext;
        document.getElementById('popup-restart-btn').disabled = false;
        document.getElementById('popup-finish-btn').disabled = false;
      }

      // 알림 표시
      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 3000);
      }
    }

    // 앱 초기화
    document.addEventListener('DOMContentLoaded', () => {
      window.lessonPlatform = new SafeLessonPlatform();
    });
  </script>
</body>
</html>